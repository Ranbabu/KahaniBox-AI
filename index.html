<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KahaniBox AI - News Studio</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #3b82f6; --border: #334155; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .main-container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 20px; }
        
        header { text-align: center; margin-bottom: 10px; }
        h1 { font-size: 2.2rem; background: linear-gradient(to right, #60a5fa, #c084fc); -webkit-background-clip: text; color: transparent; font-weight: 800; }
        
        /* Controls Section */
        .controls { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        label { font-size: 0.9rem; color: #94a3b8; margin-bottom: 5px; display: block; }
        select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid var(--border); color: white; border-radius: 8px; outline: none; }
        
        .full-width { grid-column: span 2; }
        
        .btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: var(--border); cursor: not-allowed; }

        /* Output Boxes */
        .box-container { display: none; flex-direction: column; gap: 20px; }
        
        .box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .box-header { background: #263346; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .box-title { font-weight: bold; color: #cbd5e1; font-size: 0.95rem; }
        .box-content { padding: 15px; max-height: 300px; overflow-y: auto; color: #e2e8f0; white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem; }
        
        /* Specific Box Styles */
        .meta-item { display: flex; justify-content: space-between; border-bottom: 1px solid #334155; padding: 8px 0; font-size: 0.85rem; }
        .meta-source { color: #4ade80; font-weight: bold; }
        .meta-time { color: #94a3b8; }
        
        .script-content { font-size: 1.1rem; line-height: 1.8; }

        /* Buttons inside boxes */
        .copy-btn { background: #334155; border: none; color: white; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .copy-btn:active { background: #475569; }

        /* Voice Controls */
        .audio-bar { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }
        .icon-btn { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 1.2rem; }
        .stop-btn { color: #ef4444; display: none; }

        .loader { text-align: center; display: none; color: var(--accent); font-weight: bold; margin-top: 10px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="main-container">
        <header>
            <h1>News Studio AI üì°</h1>
            <p>Real-time Google News Aggregator & Script Writer</p>
        </header>

        <div class="controls">
            <div>
                <label>‡§ï‡§ø‡§§‡§®‡•Ä ‡§ñ‡§¨‡§∞‡•á‡§Ç ‡§ö‡§æ‡§π‡§ø‡§è? (Count)</label>
                <select id="newsCount">
                    <option value="5">Top 5 Headlines</option>
                    <option value="10">Top 10 Headlines</option>
                    <option value="15">Top 15 Headlines</option>
                    <option value="25">Top 25 Headlines</option>
                </select>
            </div>

            <div>
                <label>‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§ï‡•Ä ‡§≤‡§Ç‡§¨‡§æ‡§à (Per News)</label>
                <select id="lineCount">
                    <option value="2 lines">2 Lines (Short)</option>
                    <option value="3 lines">3 Lines (Standard)</option>
                    <option value="5 lines">5 Lines (Detailed)</option>
                    <option value="10 lines">10 Lines (Deep Dive)</option>
                </select>
            </div>

            <div class="full-width">
                <button class="btn" id="fetchBtn" onclick="fetchNews()">üî¥ Fetch Live News & Generate Script</button>
                <div class="loader" id="loader">Google ‡§∏‡•á ‡§ñ‡§¨‡§∞‡•á‡§Ç ‡§≤‡§æ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å ‡§î‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§≤‡§ø‡§ñ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å... ‚è≥</div>
            </div>
        </div>

        <div class="box-container" id="outputSection">
            
            <div class="box">
                <div class="box-header">
                    <span class="box-title">‚ÑπÔ∏è Source & Time Info</span>
                </div>
                <div class="box-content" id="metaBox">
                    </div>
            </div>

            <div class="box">
                <div class="box-header">
                    <span class="box-title">üì∞ Top Headlines</span>
                    <button class="copy-btn" onclick="copyText('headlineBox')">Copy Headlines</button>
                </div>
                <div class="box-content" id="headlineBox">
                    </div>
            </div>

            <div class="box">
                <div class="box-header">
                    <span class="box-title">üéôÔ∏è AI Anchor Script</span>
                    <div style="display:flex; gap:10px;">
                        <button class="copy-btn" onclick="copyText('scriptBox')">Copy Script</button>
                    </div>
                </div>
                <div class="box-content script-content" id="scriptBox">
                    </div>
                <div style="padding: 10px 15px;">
                    <select id="voiceSelect" style="margin-bottom: 5px;"><option>Loading Voices...</option></select>
                    <div class="audio-bar">
                        <button class="icon-btn" id="playBtn" onclick="speakScript()">‚ñ∂Ô∏è Read News</button>
                        <button class="icon-btn stop-btn" id="stopBtn" onclick="stopSpeaking()">‚èπÔ∏è Stop</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Audio Logic ---
        let synth = window.speechSynthesis;
        let voices = [];
        let isSpeaking = false;

        function loadVoices() {
            voices = synth.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = ''; 
            let bestHindi = -1;
            voices.forEach((v, i) => {
                const opt = document.createElement('option');
                opt.textContent = `${v.name} (${v.lang})`;
                opt.value = i;
                voiceSelect.appendChild(opt);
                if (v.lang.includes('hi') || v.lang.includes('IN')) bestHindi = i;
            });
            if (bestHindi !== -1) voiceSelect.selectedIndex = bestHindi;
        }
        speechSynthesis.onvoiceschanged = loadVoices;

        // --- Fetch Logic ---
        async function fetchNews() {
            const count = document.getElementById('newsCount').value;
            const lines = document.getElementById('lineCount').value;
            const btn = document.getElementById('fetchBtn');
            const loader = document.getElementById('loader');
            const outputSection = document.getElementById('outputSection');

            // Clear previous
            document.getElementById('metaBox').innerHTML = '';
            document.getElementById('headlineBox').innerHTML = '';
            document.getElementById('scriptBox').innerText = '';

            btn.disabled = true;
            loader.style.display = 'block';
            outputSection.style.display = 'none';

            try {
                const response = await fetch('/api/generate-news', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count, lines })
                });

                const data = await response.json();

                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    displayResults(data.metadata, data.script);
                }

            } catch (err) {
                alert("Network Error: " + err.message);
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }

        function displayResults(metadata, script) {
            const outputSection = document.getElementById('outputSection');
            const metaBox = document.getElementById('metaBox');
            const headlineBox = document.getElementById('headlineBox');
            const scriptBox = document.getElementById('scriptBox');

            outputSection.style.display = 'flex';

            // 1. Fill Metadata Box & Headline Box
            let headlinesText = "";
            
            metadata.forEach((item, index) => {
                // Meta Box Entry
                const dateObj = new Date(item.pubDate);
                const timeStr = dateObj.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                const dateStr = dateObj.toLocaleDateString('en-IN');

                const metaDiv = document.createElement('div');
                metaDiv.className = 'meta-item';
                metaDiv.innerHTML = `
                    <span>${index + 1}. <span class="meta-source">${item.source}</span></span>
                    <span class="meta-time">${timeStr} | ${dateStr}</span>
                `;
                metaBox.appendChild(metaDiv);

                // Headline Box Entry
                const p = document.createElement('p');
                p.style.marginBottom = "10px";
                p.textContent = `${index + 1}. ${item.title}`;
                headlineBox.appendChild(p);

                headlinesText += `${index + 1}. ${item.title}\n`;
            });

            // 2. Fill Script Box
            scriptBox.innerText = script;
        }

        function copyText(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert("Copied to clipboard!");
            });
        }

        // --- Speech Logic ---
        function speakScript() {
            stopSpeaking();
            const text = document.getElementById('scriptBox').innerText;
            if(!text) return;

            const utterance = new SpeechSynthesisUtterance(text);
            const voiceIdx = document.getElementById('voiceSelect').value;
            if (voices[voiceIdx]) utterance.voice = voices[voiceIdx];
            
            utterance.rate = 1.0;

            utterance.onstart = () => {
                document.getElementById('playBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'flex';
            };
            utterance.onend = () => {
                stopSpeaking();
            };

            synth.speak(utterance);
        }

        function stopSpeaking() {
            synth.cancel();
            document.getElementById('playBtn').style.display = 'flex';
            document.getElementById('stopBtn').style.display = 'none';
        }
    </script>
</body>
</html>
