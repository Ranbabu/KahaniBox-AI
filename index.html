<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Studio AI</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #8b5cf6; --border: #334155; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .main-container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 20px; }
        
        header { text-align: center; margin-bottom: 10px; }
        h1 { font-size: 2.2rem; background: linear-gradient(to right, #a78bfa, #f472b6); -webkit-background-clip: text; color: transparent; font-weight: 800; }
        p { color: #94a3b8; }

        /* Controls */
        .controls { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        label { font-size: 0.9rem; color: #94a3b8; margin-bottom: 5px; display: block; }
        select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid var(--border); color: white; border-radius: 8px; outline: none; }
        .full-width { grid-column: span 2; }
        
        .btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: var(--border); cursor: not-allowed; }

        /* Boxes */
        .box-container { display: none; flex-direction: column; gap: 20px; }
        .box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .box-header { background: #2d3748; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .box-title { font-weight: bold; color: #cbd5e1; font-size: 1rem; }
        
        /* Content Areas */
        .box-content { padding: 15px; max-height: 350px; overflow-y: auto; color: #e2e8f0; white-space: pre-wrap; line-height: 1.8; font-size: 1rem; }
        
        .meta-item { display: flex; justify-content: space-between; border-bottom: 1px solid #334155; padding: 8px 0; font-size: 0.9rem; }
        .meta-item:last-child { border-bottom: none; }
        .meta-source { color: #34d399; font-weight: bold; }
        .meta-time { color: #94a3b8; }

        .headline-item { padding: 10px 0; border-bottom: 1px dashed #334155; font-size: 1.05rem; }
        .headline-item:last-child { border-bottom: none; }

        .script-text { font-size: 1.15rem; color: #f8fafc; font-weight: 400; letter-spacing: 0.3px; }

        /* Buttons */
        .copy-btn { background: #475569; border: none; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        .copy-btn:hover { background: #64748b; }
        
        .refresh-btn { background: none; border: 1px solid #475569; color: #94a3b8; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 0.8rem; margin-left: 5px; }

        /* Audio Controls */
        .audio-wrapper { padding: 15px; background: #1e293b; border-top: 1px solid #334155; }
        .voice-selection-row { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; }
        
        .audio-bar { display: flex; gap: 10px; align-items: center; justify-content: center; }
        .icon-btn { background: var(--accent); border: none; color: white; cursor: pointer; font-size: 1rem; padding: 10px 20px; border-radius: 50px; display: flex; align-items: center; gap: 8px; font-weight: bold; transition: 0.2s; }
        .icon-btn:hover { opacity: 0.9; }
        .stop-btn { background: #ef4444; display: none; }

        .loader { text-align: center; display: none; color: var(--accent); font-weight: bold; margin-top: 10px; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="main-container">
        <header>
            <h1>News Studio AI üéôÔ∏è</h1>
            <p>Professional News Script Generator</p>
        </header>

        <div class="controls">
            <div>
                <label>Headlines Count</label>
                <select id="newsCount">
                    <option value="5">Top 5 Headlines</option>
                    <option value="10">Top 10 Headlines</option>
                    <option value="15">Top 15 Headlines</option>
                    <option value="25">Top 25 Headlines</option>
                </select>
            </div>
            <div>
                <label>Script Length (Per News)</label>
                <select id="lineCount">
                    <option value="2 lines">2 Lines (Brief)</option>
                    <option value="3 lines">3 Lines (Standard)</option>
                    <option value="5 lines">5 Lines (Detailed)</option>
                    <option value="10 lines">10 Lines (Deep Dive)</option>
                </select>
            </div>
            <div class="full-width">
                <button class="btn" id="fetchBtn" onclick="fetchNews()">üî¥ Fetch Live News & Generate</button>
                <div class="loader" id="loader">Fetching News & Writing Professional Script... ‚è≥</div>
            </div>
        </div>

        <div class="box-container" id="outputSection">
            
            <div class="box">
                <div class="box-header">
                    <span class="box-title">‚ÑπÔ∏è Source & Time</span>
                </div>
                <div class="box-content" id="metaBox"></div>
            </div>

            <div class="box">
                <div class="box-header">
                    <span class="box-title">üì∞ Headlines</span>
                    <button class="copy-btn" onclick="copyText('headlineBox')">Copy Headlines</button>
                </div>
                <div class="box-content" id="headlineBox"></div>
            </div>

            <div class="box">
                <div class="box-header">
                    <span class="box-title">üéôÔ∏è AI Anchor Script (Clean)</span>
                    <button class="copy-btn" onclick="copyText('scriptBox')">Copy Script</button>
                </div>
                <div class="box-content script-text" id="scriptBox"></div>
                
                <div class="audio-wrapper">
                    <label style="font-size: 0.8rem; color: #94a3b8; display:block; margin-bottom:5px;">
                        Select Voice (Use Edge Browser for Madhur/Swara):
                    </label>
                    
                    <div class="voice-selection-row">
                        <select id="voiceSelect" style="width:100%;">
                            <option>Wait, Loading Voices...</option>
                        </select>
                        <button class="refresh-btn" onclick="loadVoices(true)" title="Reload Voices">üîÑ</button>
                    </div>

                    <div class="audio-bar">
                        <button class="icon-btn" id="playBtn" onclick="speakScript()">‚ñ∂Ô∏è Read Aloud</button>
                        <button class="icon-btn stop-btn" id="stopBtn" onclick="stopSpeaking()">‚èπÔ∏è Stop Reading</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let synth = window.speechSynthesis;
        let voices = [];
        let isSpeaking = false;
        let voiceLoadAttempts = 0;

        // --- IMPROVED VOICE LOADING LOGIC ---
        function loadVoices(isManual = false) {
            voices = synth.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            
            // Debugging log for mobile
            console.log("Voices loaded:", voices.length);

            if (voices.length === 0) {
                if (isManual) alert("No voices found yet. Try opening in Microsoft Edge.");
                
                // Retry automatically a few times
                if (voiceLoadAttempts < 5 && !isManual) {
                    voiceLoadAttempts++;
                    setTimeout(loadVoices, 500); // Try again in 500ms
                }
                return;
            }

            // If voices found, populate list
            voiceSelect.innerHTML = ''; 
            let selectedIndex = 0;
            let madhurIndex = -1;
            let swaraIndex = -1;
            let otherHindiIndex = -1;

            voices.forEach((v, i) => {
                const opt = document.createElement('option');
                opt.textContent = `${v.name} (${v.lang})`;
                opt.value = i;
                voiceSelect.appendChild(opt);

                // Priority Logic
                if (v.name.includes("Madhur")) {
                    madhurIndex = i;
                    opt.textContent = "üåü " + opt.textContent; // Star for priority
                } else if (v.name.includes("Swara") || v.name.includes("Sara")) {
                    swaraIndex = i;
                    opt.textContent = "üåü " + opt.textContent;
                } else if (v.lang.includes('hi') || v.lang.includes('IN')) {
                    if (otherHindiIndex === -1) otherHindiIndex = i;
                }
            });

            // Auto-Select Logic: Madhur > Swara > Hindi > First Available
            if (madhurIndex !== -1) {
                voiceSelect.selectedIndex = madhurIndex;
            } else if (swaraIndex !== -1) {
                voiceSelect.selectedIndex = swaraIndex;
            } else if (otherHindiIndex !== -1) {
                voiceSelect.selectedIndex = otherHindiIndex;
            } else {
                voiceSelect.selectedIndex = 0; // Fallback to first voice
            }
        }

        // Trigger Voice Load on multiple events to catch mobile quirks
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        // Force retry after 1 sec for slow mobile browsers
        setTimeout(loadVoices, 1000);

        async function fetchNews() {
            const count = document.getElementById('newsCount').value;
            const lines = document.getElementById('lineCount').value;
            const btn = document.getElementById('fetchBtn');
            const loader = document.getElementById('loader');
            const outputSection = document.getElementById('outputSection');

            // Reset Output
            document.getElementById('metaBox').innerHTML = '';
            document.getElementById('headlineBox').innerHTML = '';
            document.getElementById('scriptBox').innerText = '';

            btn.disabled = true;
            loader.style.display = 'block';
            outputSection.style.display = 'none';

            try {
                // Fetch from your backend
                const response = await fetch('/api/generate-news', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count, lines })
                });

                const data = await response.json();

                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    displayResults(data.metadata, data.script);
                }

            } catch (err) {
                alert("Connection Error. Please check internet.");
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }

        function displayResults(metadata, script) {
            const outputSection = document.getElementById('outputSection');
            const metaBox = document.getElementById('metaBox');
            const headlineBox = document.getElementById('headlineBox');
            const scriptBox = document.getElementById('scriptBox');

            outputSection.style.display = 'flex';

            metadata.forEach((item) => {
                const dateObj = new Date(item.pubDate);
                const timeStr = dateObj.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                const dateStr = dateObj.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });

                // Source
                const metaDiv = document.createElement('div');
                metaDiv.className = 'meta-item';
                metaDiv.innerHTML = `
                    <span class="meta-source">${item.source}</span>
                    <span class="meta-time">${timeStr} | ${dateStr}</span>
                `;
                metaBox.appendChild(metaDiv);

                // Headline
                const p = document.createElement('div');
                p.className = 'headline-item';
                p.textContent = item.title;
                headlineBox.appendChild(p);
            });

            scriptBox.innerText = script;
            
            // Try loading voices again now that user interaction happened
            loadVoices(); 
        }

        function copyText(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => alert("Copied!"));
        }

        function speakScript() {
            stopSpeaking();
            const text = document.getElementById('scriptBox').innerText;
            if(!text) return;

            // Voice Check
            const voiceSelect = document.getElementById('voiceSelect');
            if (voiceSelect.options.length === 0) {
                loadVoices(true); // Try to force load
                if (voiceSelect.options.length === 0) {
                    alert("Voices not loaded yet. Please wait or refresh page.");
                    return;
                }
            }

            const utterance = new SpeechSynthesisUtterance(text);
            const voiceIdx = voiceSelect.value;
            
            if (voices[voiceIdx]) {
                utterance.voice = voices[voiceIdx];
            }
            
            utterance.rate = 1.0;
            utterance.pitch = 1.0;

            utterance.onstart = () => {
                document.getElementById('playBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'flex';
            };
            utterance.onend = stopSpeaking;
            utterance.onerror = (e) => {
                console.error("Speech Error:", e);
                stopSpeaking();
            };

            synth.speak(utterance);
        }

        function stopSpeaking() {
            synth.cancel();
            document.getElementById('playBtn').style.display = 'flex';
            document.getElementById('stopBtn').style.display = 'none';
        }
    </script>
</body>
</html>
